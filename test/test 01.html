<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>
  <button id="btn1">试验按钮1</button>
  <button id="btn2">试验按钮2</button>
  <button id="btn3">试验按钮3</button>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    const btn1 = document.getElementById('btn1')
    const btn2 = document.getElementById('btn2')
    const btn3 = document.getElementById('btn3')
    let token = '';
    // 使用拦截器 ，解决代码的重复，简化代码量
    //创建一个axios 实例
    const axiosInstance = axios.create({
      baseUrl: 'http://localhost:5000/api', //  基础路径，所有请求的公共路径
      timeout: 5000, //请求响应时间
      headers: {
        // 'content-type': 'application/x-www-form-urlencoded'，公共的请求头参数，因为token值是空的，所以有值会报错
      }
    })
    axiosInstance.interceptors.request.use(
      config => {
        if (method.state === 'post') {
          config.headers['content-type'] = 'application/x-www-form-urlencoded'
          //修改数据config.data数据

        }
        if (token) {
          config.headers.authorization = 'Bearer ' + token
        }
        return config
      },
      err => {
        return Promise.reject(err)
      })

    axios.defaults.withCredentials = true
    axios.defaults.timeout = 10000
    //定义状态码
    const codeMessage = {
      200: '服务器成功返回请求的数据。',
      201: '新建或修改数据成功。',
      202: '一个请求已经进入后台排队（异步任务）。',
      204: '删除数据成功。',
      400: '发出的请求有错误，服务器没有进行新建或修改数据的操作。',
      401: '用户没有权限（令牌、用户名、密码错误）。',
      403: '用户得到授权，但是访问是被禁止的。',
      404: '发出的请求针对的是不存在的记录，服务器没有进行操作。',
      406: '请求的格式不可得。',
      410: '请求的资源被永久删除，且不会再得到的。',
      422: '当创建一个对象时，发生一个验证错误。',
      500: '服务器发生错误，请检查服务器。',
      502: '网关错误。',
      503: '服务不可用，服务器暂时过载或维护。',
      504: '网关超时。',
    }
    // axiosSetting.js
    // request拦截器
    axios.interceptors.request.use(
      config => {
        // Do something before request is sent
        const token = getToken()
        // console.log(window.location.href.indexOf('/user/login') > -1)
        if (config.url.indexOf('/auth/oauth/token') > 0) {
          config.headers.Authorization = 'Basic dnVlOnZ1ZQ==' // 增加客户端认证
        } else {
          config.headers.Authorization = token // 让每个请求携带token--['X-Token']为自定义key 请根据实际情况自行修改
        }
        const {
          url
        } = config
        if (/^\/api\//.test(url) && !token && !window.location.href.indexOf('user') > -1) {
          const {
            dispatch
          } = store
          dispatch(routerRedux.replace('/user/login')) // 跳转到登录页
        }
        return config
      },
      error => {
        // Do something with request error
        console.log(error) // for debug
        Promise.reject(error)
      }
    )
    // respone拦截器
    axios.interceptors.response.use(
      response => {
        /**
         * 下面的注释为通过response自定义code来标示请求状态，当code返回如下情况为权限有问题，登出并返回到登录页
         * 如通过xmlhttprequest 状态码标识 逻辑可写在下面error中
         */
        const res = response.data
        // if (response.status === 401 || res.status === 40101) {
        //   MessageBox.confirm('你已被登出，可以取消继续留在该页面，或者重新登录', '确定登出', {
        //     confirmButtonText: '重新登录',
        //     cancelButtonText: '取消',
        //     type: 'warning'
        //   }).then(() => {
        //     store.dispatch('LogOut').then(() => {
        //       location.reload() // 为了重新实例化vue-router对象 避免bug
        //     })
        //   })
        //   return Promise.reject('error')
        // }
        // if (res.status === 30101) {
        //   Message({
        //     message: res.message,
        //     type: 'error',
        //     duration: 5 * 1000
        //   })
        //   return Promise.reject('error')
        // }
        // if (res.status === 40301) {
        //   Message({
        //     message: '当前用户无相关操作权限！',
        //     type: 'error',
        //     duration: 5 * 1000
        //   })
        //   return Promise.reject('error')
        // }
        if (response.status !== 200 && res.status !== 200) {
          message.error(response.data.message)
          // notification.error({
          //     message: res.status,
          //     description: res.message,
          // })
        } else {
          return response.data
        }
      },
      error => {
        // console.log(JSON.stringify(error)) // for debug
        if (error === undefined || error.code === 'ECONNABORTED') {
          message.warning('服务请求超时')
          return Promise.reject(error)
        }
        const {
          response: {
            status,
            statusText,
            data: {
              msg = '服务器发生错误'
            }
          }
        } = error
        const {
          response
        } = error
        const {
          dispatch
        } = store
        const text = codeMessage[status] || statusText || msg

        if (status === 400) {
          // message.warning('账户或密码错误！')
          dispatch(routerRedux.push('/user/login'))
        }
        const info = response.data
        if (status === 401 || info.status === 40101) {
          dispatch({
            type: 'login/logout',
          })
          // MessageBox.confirm('你已被登出，可以取消继续留在该页面，或者重新登录', '确定登出', {
          //     confirmButtonText: '重新登录',
          //     cancelButtonText: '取消',
          //     type: 'warning',
          // }).then(() => {
          //     store.dispatch('LogOut').then(() => {
          //         location.reload() // 为了重新实例化vue-router对象 避免bug
          //     })
          // })
        }
        if (status === 403) {
          dispatch(routerRedux.push('/exception/403'))
          // Notification.warning({
          //     title: '禁止',
          //     message: info.message,
          //     type: 'error',
          //     duration: 2 * 1000,
          // })
        }
        if (info.status === 30101) {
          dispatch(routerRedux.push('/exception/500'))
          // Notification.warning({
          //     title: '失败',
          //     message: info.message,
          //     type: 'error',
          //     duration: 2 * 1000,
          // })
        }
        if (response.status === 504) {
          dispatch(routerRedux.push('/exception/500'))
          // Message({
          //     message: '后端服务异常，请联系管理员！',
          //     type: 'error',
          //     duration: 5 * 1000,
          // })
        }
        message.error(`${status}:${text}`)
        // throw error
        // return error
        return Promise.reject(error)
      }
    )



    btn1.onclick = function () {
      //发送请求
      axiosInstance({
          method: 'POST',
          url: '/login',
          data: 'username=admin&password=admin',
          headers: {
            // 'content-type': 'application/x-www-form-urlencoded'
          }
        })
        .then((response) => {
          if (response.data.status === 0) {
            //成功登陆
            console.log(response.data.data)
            token = response.data.data.token
          } else {
            console.log(response.data.msg)
          }
        })
        .catch((error) => {
          console.log(error)
          alert('网络故障，刷新试试。。。。。')
        })
    }
    btn2.onclick = function () {
      axiosInstance({
          method: 'GET',
          url: '/category/get',
          headers: {
            // 'authorization': 'Bearer ' + token
          },
        })
        .then((response) => {
          if (response.data.status === 0) {
            console.log(response.data.data)
          } else {
            console.log(response.data.msg)
          }
        })
        .catch((err) => {
          alert('网络故障，请刷新试试~~')
        })
    }
    btn3.onclick = function () {
      axiosInstance({
          method: 'POST',
          url: '/category/add',
          data: 'categoryName=项目',
          headers: {
            // 'content-type': 'application/x-www-form-urlencoded',
            // 'authorization': 'Bearer ' + token,
          }
        })
        .then((response) => {
          if (response.data.status === 0) {
            console.log(response.data.data)
          } else {
            console.log(response.data.msg)
          }
        })
        .catch((err) => {
          alert('网络崩溃了~~~')
        })
    }
  </script>
</body>

</html>